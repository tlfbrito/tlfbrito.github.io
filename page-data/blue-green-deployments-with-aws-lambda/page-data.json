{"componentChunkName":"component---src-templates-blog-post-js","path":"/blue-green-deployments-with-aws-lambda/","result":{"data":{"site":{"siteMetadata":{"title":"Tiago Brito","author":"Tiago Brito"}},"markdownRemark":{"id":"69ada477-9e46-5c85-a9a9-32692792693b","html":"<p>Serverless computing is a cloud-based execution model that enables applications to be hosted as a service,\nwithout the need to maintain a server. Serverless &#x26; Lambda functions have become very popular in\nCloud infrastructures from small to enterprise companies.</p>\n<p>In this example will we are going to deploy a Symfony application (PHP) to AWS Lambda, using the following stack:</p>\n<ul>\n<li><a href=\"https://bref.sh/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bref</a></li>\n<li>Serverless Framework + serverless-plugin-canary-deployments</li>\n</ul>\n<p>On top of the classic PHP on AWS Lambda setup, this example will also configure AWS CloudWatch alerts and\nsetup CodeDeploy to manage Blue/green canary deployments based on errors that are monitored using AWS CloudWatch.</p>\n<hr/>\n<h4 id=\"create-our-symfony-app\"><a href=\"#create-our-symfony-app\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create our Symfony app:</h4>\n<p><code class=\"language-text\">symfony new bref-canary-deployments-demo</code> </p>\n<h4 id=\"install-bref\"><a href=\"#install-bref\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install Bref:</h4>\n<p><code class=\"language-text\">composer req bref/bref</code></p>\n<p>Learn more on how to setup a Symfony app here: <a href=\"https://bref.sh/docs/frameworks/symfony.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://bref.sh/docs/frameworks/symfony.html</a></p>\n<p>I’m not going to focus on how to setup the Symfony application with Bref. If you have doubts or issues, you should follow the\nofficial documentation.</p>\n<h4 id=\"deploy\"><a href=\"#deploy\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy:</h4>\n<p><code class=\"language-text\">sls deploy</code></p>\n<p>Under the wood, these steps have created the following infrastructure:</p>\n<ul>\n<li>AWS Lambda function with a custom PHP layer managed by Bref.</li>\n<li>An API Gateway</li>\n</ul>\n<p>Until here, nothing new. This is a typical Serverless application, independent if you are deploying a PHP (customer layer)\nor a native AWS supported runtime (eg: NodeJS) you should relate to these steps and configurations.</p>\n<p>Now we are going to setup the blue/gree deployments with gradually traffic shifting and automatic rollback.</p>\n<h4 id=\"install-serverless-plugin-canary-deployments\"><a href=\"#install-serverless-plugin-canary-deployments\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install serverless-plugin-canary-deployments:</h4>\n<p><code class=\"language-text\">npm i --save-dev serverless-plugin-canary-deployments</code></p>\n<p>Enable <code class=\"language-text\">serverless-plugin-canary-deployments</code> on serverless framework configuration:</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token comment\">#serverless.yml</span>\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> ./vendor/bref/bref\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>canary<span class=\"token punctuation\">-</span>deployments</span>\n<span class=\"token comment\"># ...</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id=\"configure-the-gradually-traffic-shifting\"><a href=\"#configure-the-gradually-traffic-shifting\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configure the gradually traffic shifting:</h4>\n<p>The new <code class=\"language-text\">deploymentSettings</code> will configure AWS CodeDeploy according to the defined <code class=\"language-text\">type</code> to deploy our Lambda\nwhile the traffic is shifted in equal increments with an equal number of minutes between each increment.\nIn our example: <code class=\"language-text\">Linear10PercentEvery1Minute</code> - Shift 10 percent of the traffic, every 1 minute.\nYou can read more on the different Deployment Types here: <a href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/automating-updates-to-serverless-apps.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/automating-updates-to-serverless-apps.html</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token comment\">#serverless.yml</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">website</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> public/index.php\n    <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">28</span> <span class=\"token comment\"># in seconds (API Gateway has a timeout of 29 seconds)</span>\n    <span class=\"token key atrule\">layers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> $<span class=\"token punctuation\">{</span>bref<span class=\"token punctuation\">:</span>layer.php<span class=\"token punctuation\">-</span>74<span class=\"token punctuation\">-</span>fpm<span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span>   <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ANY /'</span>\n      <span class=\"token punctuation\">-</span>   <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ANY /{proxy+}'</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token key atrule\">deploymentSettings</span><span class=\"token punctuation\">:</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Linear10PercentEvery1Minute</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token key atrule\">alias</span><span class=\"token punctuation\">:</span> Live</span>      <span class=\"token key atrule\">alarms</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> ApiGateway5XXErrorAlarm\n\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">ApiGateway5XXErrorAlarm</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'AWS::CloudWatch::Alarm'</span>\n      <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">AlarmDescription</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Api Gateway server-side errors captured'</span>\n        <span class=\"token key atrule\">Namespace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'AWS/ApiGateway'</span>\n        <span class=\"token key atrule\">MetricName</span><span class=\"token punctuation\">:</span> 5XXError\n        <span class=\"token key atrule\">Dimensions</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Name</span><span class=\"token punctuation\">:</span> ApiName\n            <span class=\"token key atrule\">Value</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>provider.stage<span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>service<span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">Statistic</span><span class=\"token punctuation\">:</span> Sum\n        <span class=\"token key atrule\">Period</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span>\n        <span class=\"token key atrule\">EvaluationPeriods</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n        <span class=\"token key atrule\">Threshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n        <span class=\"token key atrule\">ComparisonOperator</span><span class=\"token punctuation\">:</span> GreaterThanOrEqualToThreshold</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On the following lines, we define and configure AWS CloudWatch to monitor our Lambda or API Gateway\nthat AWS CodeDeploy will use as Threshold to decide if it should rollback or not the current deploy.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token comment\">#serverless.yml</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">website</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> public/index.php\n    <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">28</span> <span class=\"token comment\"># in seconds (API Gateway has a timeout of 29 seconds)</span>\n    <span class=\"token key atrule\">layers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> $<span class=\"token punctuation\">{</span>bref<span class=\"token punctuation\">:</span>layer.php<span class=\"token punctuation\">-</span>74<span class=\"token punctuation\">-</span>fpm<span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span>   <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ANY /'</span>\n      <span class=\"token punctuation\">-</span>   <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ANY /{proxy+}'</span>\n    <span class=\"token key atrule\">deploymentSettings</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Linear10PercentEvery1Minute\n      <span class=\"token key atrule\">alias</span><span class=\"token punctuation\">:</span> Live\n      <span class=\"token key atrule\">alarms</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> ApiGateway5XXErrorAlarm\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token key atrule\">ApiGateway5XXErrorAlarm</span><span class=\"token punctuation\">:</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'AWS::CloudWatch::Alarm'</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">AlarmDescription</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Api Gateway server-side errors captured'</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">Namespace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'AWS/ApiGateway'</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">MetricName</span><span class=\"token punctuation\">:</span> 5XXError</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">Dimensions</span><span class=\"token punctuation\">:</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Name</span><span class=\"token punctuation\">:</span> ApiName</span><span class=\"gatsby-highlight-code-line\">            <span class=\"token key atrule\">Value</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>provider.stage<span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>service<span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">Statistic</span><span class=\"token punctuation\">:</span> Sum</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">Period</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">EvaluationPeriods</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">Threshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">ComparisonOperator</span><span class=\"token punctuation\">:</span> GreaterThanOrEqualToThreshold</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id=\"redeploy\"><a href=\"#redeploy\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(Re)Deploy:</h4>\n<p><code class=\"language-text\">sls deploy</code></p>\n<p>After you initiate a second deploy, it will create an additional set of resources on AWS:</p>\n<ul>\n<li>An Alarm on AWS CloudWatch</li>\n<li>An Application on CodeDeploy</li>\n</ul>\n<figure>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/2f3f5806ed9ffa3e4c7958a575e3ef2b/31df8/cloud-watch-alarm.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABp0lEQVQoz4VTiU7jMBTM/38abHe1LELdNAfbQqFpnMRH7KQ5hrFDEQsqRBqN41jvzTxPot3DI7Q2cM5BKY2DKFBWAnUjiQaiqlAK8R+OJRG4XNZkf05pjUhUNVzXoW0tLIumeY6r6xV+/vqN6x8r3Py5DXtxkiDJMmzSFOu/MeJNgrv1GpskDet/291ScL/foyiOeHp6Rt/3odP9dossv0eSZqF7a1toYz7BtC2kUgFeWCMlIklljWmhWlq2HT9qGB72qhflSzFzAaWoQlPPvnC0uo1xE+dIHws8NB0OVYPicMAwDBjfYbgAQzGNn7esQ+Moe+YlmBNqN6LuJgipUXLQjva7/oTudMI0z/jucaOD4WgiQYsepVQ4spOxFgOtjrQ6sPtAHrk3fYGRY2N3WOsQKfpWWjE6mjOQ3O8xTxPmcVz4vL6AifAj8ed8SqLllnS48oZrn8fJF6GNmVbfcH4PjIU/2LZUG6mgTOHMhvL9cH3hzoP238O97nl2LCAZ/qIowlmfireCi0rmqVH8U2pmz4aOH9G+whcUnPldukW+Y5bLKsToBSS6THB4EdZRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"CloudWatch Alarm\" title=\"CloudWatch Alarm\" src=\"/static/2f3f5806ed9ffa3e4c7958a575e3ef2b/fcda8/cloud-watch-alarm.png\" srcset=\"/static/2f3f5806ed9ffa3e4c7958a575e3ef2b/12f09/cloud-watch-alarm.png 148w,\n/static/2f3f5806ed9ffa3e4c7958a575e3ef2b/e4a3f/cloud-watch-alarm.png 295w,\n/static/2f3f5806ed9ffa3e4c7958a575e3ef2b/fcda8/cloud-watch-alarm.png 590w,\n/static/2f3f5806ed9ffa3e4c7958a575e3ef2b/efc66/cloud-watch-alarm.png 885w,\n/static/2f3f5806ed9ffa3e4c7958a575e3ef2b/c83ae/cloud-watch-alarm.png 1180w,\n/static/2f3f5806ed9ffa3e4c7958a575e3ef2b/31df8/cloud-watch-alarm.png 2366w\" sizes=\"(max-width: 590px) 100vw, 590px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n  <figcaption>CloudWatch Alarm</figcaption>\n</figure>\n<p><strong>Important:</strong> We choose to setup our Alarm for API Gateway errors instead of using directly the lambda error metrics.\nThis happen, because Lambda Errors don’t include the application exceptions/errors,\nbecause most of the time this is handle by the Framework (eg: Symfony) or even the language itself.\nLambda errors will only take into account errors that break the runtime (eg: PHP).\nThis is why, we decided to use API Gateway error metrics instead, but you can and should monitor both.</p>\n<p>This new deploy will show up on AWS CodeDeploy:</p>\n<figure>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/8b89bdc4c9ade05d52fa469b5cf7a25a/6274f/deploy-in-progress.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 37.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABOUlEQVQoz22R3U7DMAyF+/43SDwKEleId5gQVyC0dYNp65a2adL8pwfbHUhIVDqKa5/aX51G9T222x3a/QG7tsWezq/jEd77/xUCvNHwWq2yGoFyP2qGccS56zBqjX4YoKeJ4gkhRjhqYOwsRm5krIFLFW7zAPt0B/t8D/fyiJgrInvI39h5RkwJuRTknFFr/Y05z0q3OLGP4hQcorMiiSnvZbhFw8FkDE7nDpYSwzAK0eVylRzXj7SCici5vmsPMuBMddUP5I1QqhffOGo0/HElolqYbiVbmJLOwqSkT2WgXaR8Icr4p87i9Qg5kTaRXuoCqDkj8C7KgimU9ReIfKHa68ni4+pQyNi7LJ4QPJxz0oQvlMH4aYI0XGixPK2KUlkJhIJo3jqLd1KmvPhuhEzPDfli+VyozzdQLBy74m13IAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"CodeDeploy - Deploy in Progres\" title=\"CodeDeploy - Deploy in Progres\" src=\"/static/8b89bdc4c9ade05d52fa469b5cf7a25a/fcda8/deploy-in-progress.png\" srcset=\"/static/8b89bdc4c9ade05d52fa469b5cf7a25a/12f09/deploy-in-progress.png 148w,\n/static/8b89bdc4c9ade05d52fa469b5cf7a25a/e4a3f/deploy-in-progress.png 295w,\n/static/8b89bdc4c9ade05d52fa469b5cf7a25a/fcda8/deploy-in-progress.png 590w,\n/static/8b89bdc4c9ade05d52fa469b5cf7a25a/efc66/deploy-in-progress.png 885w,\n/static/8b89bdc4c9ade05d52fa469b5cf7a25a/c83ae/deploy-in-progress.png 1180w,\n/static/8b89bdc4c9ade05d52fa469b5cf7a25a/6274f/deploy-in-progress.png 2098w\" sizes=\"(max-width: 590px) 100vw, 590px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n  <figcaption>CodeDeploy - Deploy in Progress</figcaption>\n</figure>\n<figure>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/3d5353103a3850ac3a4a2e9c7314fdbd/7da7d/traffic-shifting-progress.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmUlEQVQoz31SbU7cMBTMKTgUZ6m4Qn/3CJV6Bg6AxI/ytz+WVYsqsSwsYeNsvpzEcRLHsTO8Z1gEQq2l0ZMn4/G850Tr33+wul5js71Hq9Q/UVQSsq6RpAeIQ4ayqkLdixQJIX5KUJQVokOWQZDokOXoh+ETBkLXdcjynHQpWJ/nBfq+x2gMhnHESODKXCSEQC0lGllj8Q7wnqp/q57A4qIskVIiERIJKNWFy45g02maEMVFg10pIRqNqrcoj9A27MfJBvHjY4zb200wLIoymKbUGYM5Tm8ocbTPSsi+QWc0rPOYZsJr5f08uyBUWkMPI5ZlAS+uuqdklOq4uJsoIUNjLPTk4ciAlEF8hKcxNHrA2fkNTr//wrfLbThsyOgh3mG7u0fTtoFzziGSND/NDzAaLPi4XsOgJsPTHyucfP2JL+d/A6fNhKubB1xcbxDnMnAzG6pOh9figVprMb0D77ldHvrdPsN6m0AUNTwddH7BvuoQVxqDdS8JuWVFvwTjf/8gf9dUtWqprRl2nkMA1TYYdPfC8eXEPQNQDazZfAF+NwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"CodeDeploy - Traffic Shifting\" title=\"CodeDeploy - Traffic Shifting\" src=\"/static/3d5353103a3850ac3a4a2e9c7314fdbd/fcda8/traffic-shifting-progress.png\" srcset=\"/static/3d5353103a3850ac3a4a2e9c7314fdbd/12f09/traffic-shifting-progress.png 148w,\n/static/3d5353103a3850ac3a4a2e9c7314fdbd/e4a3f/traffic-shifting-progress.png 295w,\n/static/3d5353103a3850ac3a4a2e9c7314fdbd/fcda8/traffic-shifting-progress.png 590w,\n/static/3d5353103a3850ac3a4a2e9c7314fdbd/efc66/traffic-shifting-progress.png 885w,\n/static/3d5353103a3850ac3a4a2e9c7314fdbd/c83ae/traffic-shifting-progress.png 1180w,\n/static/3d5353103a3850ac3a4a2e9c7314fdbd/7da7d/traffic-shifting-progress.png 2120w\" sizes=\"(max-width: 590px) 100vw, 590px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n  <figcaption>CodeDeploy - Traffic Shifting</figcaption>\n</figure>\n<p>At the same time, we can also follow up on the traffic shifting progress and if we want,\nwe can also manually <em>Stop and rollback</em> the deployment.\nDuring this moment if our API Gateway Alarm detect any error, the deployment will\nbe <strong>automatically</strong> rollback by AWS CodeDeploy.</p>\n<p>This process and configuration is a great way to deploy and monitor your Serverless applications but also\nto automate the rollback process on a CI/CD pipeline.</p>\n<hr>","timeToRead":4,"frontmatter":{"title":"Blue/Green deployments with AWS Lambda","date":"July 27, 2020","spoiler":"Automatic rollback Blue/green deployments for Serverless applications with gradually traffic shifting."},"fields":{"slug":"/blue-green-deployments-with-aws-lambda/","langKey":"en","tags":["symfony","lambda","aws","php","deploy","deployment","bref","serverless-framework"]}}},"pageContext":{"slug":"/blue-green-deployments-with-aws-lambda/","previous":{"fields":{"slug":"/moving-from-medium-to-static-blog/","langKey":"en","directoryName":"moving-from-medium-to-static-blog","maybeAbsoluteLinks":[]},"frontmatter":{"title":"Moving away from Medium"}},"next":null,"translations":[],"translatedLinks":[]}}}