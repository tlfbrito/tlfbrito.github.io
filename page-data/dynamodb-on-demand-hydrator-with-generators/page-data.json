{"componentChunkName":"component---src-templates-blog-post-js","path":"/dynamodb-on-demand-hydrator-with-generators/","result":{"data":{"site":{"siteMetadata":{"title":"Tiago Brito","author":"Tiago Brito"}},"markdownRemark":{"id":"8b0fa228-ba3b-5b15-831a-b95f2607516a","html":"<p>Sometime ago I wrote <a href=\"/dynamodb-on-demand-hydrator/\">DynamoDb on Demand Hydrator</a>, where I show how to implement a\ncustom PHP Collection where you receive an iterator and an custom hydrator, each element of the iterator will be then\nhydrated on each collection iteration.\nThis implementation, works fine but it requires a custom collection implementation with two dependencies (iterator &#x26; hydrator).\nIf you are familiar with AWS DynamoDB client for PHP they already do the hard work of handling multiple paginated\nresults using the ResultPaginator.\nThis means, that we just need to find a way to “hook” into the iteration process itself and call our hydrator.\nSimple, but not that easy to achieve at first sight.\nGenerators in PHP are great for these type of problems. They allow you to yield the field as you iterate and still\nreturn an Iterator as a return type.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ExampleRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">DynamoDbRepository</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//more code...</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> iterable\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$parameters</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'TableName'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">finalTableName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$iterator</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getPaginator</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Scan'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$parameters</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Items'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$iterator</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$item</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">yield</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">hydrator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">hydrate</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The client() call returns a AWS DynamoDB client that will perform our scan, handle the paginated results\nand will perform the requests o DynamoDB as it needs.\nThen, on lines 12–14, we are creating a generator that will iterate and hydrate on demand our results and yield them\nto be iterated over to everyone who call ExampleRepository::getAll() method.\nNote that, as we are using > PHP 7.1 we can define iterable as a return type, which is great because it allow us to\nmatch our Iterator return type on this ExampleRepository but also would be compliant with anything that could be\niterable (such as an array) as in an InMemoryRepository implementation for example.\nAnother great feature of using AWS DynamoDB ResultPaginator iterator, is that they are compatible with PHP SPL Iterators.\nSo if you need to implement a getAll that allow you to limit the amount of the returns returned,\nyou can wrap the returned iterator with a \\LimitIterator as you can see in the next example:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ExampleRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">DynamoDbRepository</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//more code...</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAll</span><span class=\"token punctuation\">(</span>int <span class=\"token variable\">$limit</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> iterable\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$parameters</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'TableName'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">finalTableName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$iterator</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getPaginator</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Scan'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$parameters</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Items'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$limit</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$iterator</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token punctuation\">\\</span>LimitIterator</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$iterator</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$limit</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$iterator</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$item</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">yield</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">hydrator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">hydrate</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This approach have proven to be not just very efficient in memory but also allow us to process items in a\nmore dispersed way and thereafter distribute the consumed capacity units through time.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9bf69896c616864de8426ca2b19bac72/6d51e/cloudwatch-metrics.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.54455445544555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABgklEQVQoz4VR2XLjIBDU/3/eJk45Oi3bkrhtBDoAATtgbypv2wWjYY7uERRN09ZVVZUV2PK7bOrm6/Q1TWhZFq1hp6VfULCXt6O04KJo2+70efr483E+n4EIACx930/j2DZNXdWwLt2l76/DfQDqS9fdbreyLOFYUMqmDM75PEulVNbUUkqMEMopjAlj7Pl8QoRSKoQACzXFrFTMsIdP1jnxeAjOvffxfyieUqa6EDbjNhf8qg0ejXM+I4SQbPq+8Qq+nNQMHtA4H7RaYl9HZxNtrog59Qsh/IuA81YOecqFiwNPkAwv2RgP7zFlhBCEEaHUOQfBn4kKOc+JJpPp3R3+l5S1x76PTQV3Nozj0PfOmni48KMs5eyB0Biw67qt6x6PBAO/05a+q8J4T7XXNjLkmm+7rjHfZWqeZwWdm1Jm0ZvWCHNKGGWCT4jdBgaWMIIpvV7pOIn7QOhDSQUzg2Khl3V7PAhCPebwmtu27SYBcru1xlpn7W4N+JBIBziaN/4CV+Vyx7M5no4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"CloudWatch DynamoDB Metrics\"\n        title=\"CloudWatch DynamoDB Metrics\"\n        src=\"/static/9bf69896c616864de8426ca2b19bac72/b9e4f/cloudwatch-metrics.png\"\n        srcset=\"/static/9bf69896c616864de8426ca2b19bac72/cf440/cloudwatch-metrics.png 148w,\n/static/9bf69896c616864de8426ca2b19bac72/d2d38/cloudwatch-metrics.png 295w,\n/static/9bf69896c616864de8426ca2b19bac72/b9e4f/cloudwatch-metrics.png 590w,\n/static/9bf69896c616864de8426ca2b19bac72/f9b6a/cloudwatch-metrics.png 885w,\n/static/9bf69896c616864de8426ca2b19bac72/6d51e/cloudwatch-metrics.png 1010w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<hr>","timeToRead":2,"frontmatter":{"title":"DynamoDb on Demand Hydrator with Generators","date":"June 23, 2018","spoiler":"If you are familiar with AWS DynamoDB client for PHP they already do the hard work of handling multiple paginated results using the ResultPaginator."},"fields":{"slug":"/dynamodb-on-demand-hydrator-with-generators/","langKey":"en","tags":["aws","cloud","dynamodb","php","iterators"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/dynamodb-on-demand-hydrator-with-generators/","previous":{"fields":{"slug":"/validate-stripe-webhooks-with-symfony/","langKey":"en","directoryName":"validate-stripe-webhooks-with-symfony","maybeAbsoluteLinks":[]},"frontmatter":{"title":"Validate Stripe webhooks with Symfony"}},"next":{"fields":{"slug":"/3-years-at-uniplaces-and-still-counting/","langKey":"en","directoryName":"3-years-at-uniplaces-and-still-counting","maybeAbsoluteLinks":[]},"frontmatter":{"title":"3 years at Uniplaces… and still counting!"}},"translations":[],"translatedLinks":[]}}}