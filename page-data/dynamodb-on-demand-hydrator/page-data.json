{"componentChunkName":"component---src-templates-blog-post-js","path":"/dynamodb-on-demand-hydrator/","result":{"data":{"site":{"siteMetadata":{"title":"Tiago Brito","author":"Tiago Brito"}},"markdownRemark":{"id":"26a26b51-ea8b-57ef-9e05-cc3820365123","html":"<p>At Uniplaces we use a DynamoDB as our main database. DynamoDB is NoSQL and distributed database from Amazon webservices\nthat automatically spreads the data and traffic for the table over a sufficient number of servers to handle the request\ncapacity specified by the customer and the amount of data stored, while maintaining consistent and fast performance.\nBut, as everything in engineering, DynamoDB and other distributed databases come with lots of trade-offs.</p>\n<hr/>\n<h3 id=\"the-problem\"><a href=\"#the-problem\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The problem:</h3>\n<p>As a startup we started with the <a href=\"https://en.wikipedia.org/wiki/KISS_principle\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">KISS</a> principle:\nTo get a collection of items or scan an entire table we just had to ask the data to DyanmoDB and then we hydrate each\nof the items to a Domain object. This worked, and everyone was happy. At least for a while. Like Uniplaces, those tables\ngrow (a lot!) and after some time, we started to notice two problems:</p>\n<ol>\n<li>Big scans can exceed our throughput.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d7d56e72e7075a9956820d06f690aabf/b5a09/scan-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAAA5klEQVQoz5VR224EIQj1/z+yl2Q23Z2bIqjgbcrUh2760E4JIQflCBxNKaX3flwzKbU9FZt/kV046QoGw4hIa/rcHzYabpiUrdzBMLXWKz3HbDOylPY9tjAnAEEUJPF0RvrpTJQDOQuv04LgFfNXvam6tIjGX7zk0mtdILw9XGJpepSzBjMWvjLzgvy+Uq5PY+dSdwyYcuDiKKkrhsC7DxDFBd6ANKWUbxu+3J0K7qOsQApOwT6mG8WodfO6AWLrB0u24PVXSuvWgaa1HyFGJNLbs58Dld2o6v7+sPs2zVbJKcXjsn0CxEFKunEso58AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scan Example\"\n        title=\"Scan Example\"\n        src=\"/static/d7d56e72e7075a9956820d06f690aabf/fcda8/scan-1.png\"\n        srcset=\"/static/d7d56e72e7075a9956820d06f690aabf/12f09/scan-1.png 148w,\n/static/d7d56e72e7075a9956820d06f690aabf/e4a3f/scan-1.png 295w,\n/static/d7d56e72e7075a9956820d06f690aabf/fcda8/scan-1.png 590w,\n/static/d7d56e72e7075a9956820d06f690aabf/efc66/scan-1.png 885w,\n/static/d7d56e72e7075a9956820d06f690aabf/c83ae/scan-1.png 1180w,\n/static/d7d56e72e7075a9956820d06f690aabf/b5a09/scan-1.png 1360w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n<li>During the hydration process: the cost of hydrating 1 item or 100000 + 1 was exponential and not linear as expected.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9466e3bc6ad5466efc0ea867e0ebd16d/7bf07/memory-limit.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.108108108108107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsSAAALEgHS3X78AAAAVElEQVQI122KUQrAIAxDdXY/zqmjFaPi7n/MFf1dCOGRxLgfkbX22HJuxWqJNuqqfBIZZvbeFyljDNRagTnfEC4WyflJKYmU3jsAPWjZgDtGtKb+AM2bBZThqor/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Any Rating\"\n        title=\"Any Rating\"\n        src=\"/static/9466e3bc6ad5466efc0ea867e0ebd16d/fcda8/memory-limit.png\"\n        srcset=\"/static/9466e3bc6ad5466efc0ea867e0ebd16d/12f09/memory-limit.png 148w,\n/static/9466e3bc6ad5466efc0ea867e0ebd16d/e4a3f/memory-limit.png 295w,\n/static/9466e3bc6ad5466efc0ea867e0ebd16d/fcda8/memory-limit.png 590w,\n/static/9466e3bc6ad5466efc0ea867e0ebd16d/efc66/memory-limit.png 885w,\n/static/9466e3bc6ad5466efc0ea867e0ebd16d/7bf07/memory-limit.png 1128w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n</ol>\n<p>On the first point, we were requesting a huge amount of data in a same short period of time, making our consumed\ncapacity overtake our provisioned capacity.\nThe second problem is a little bit more complex. Its was the outcome of a slow hydration for big sets and in worst\ncases resulted in an “Allowed memory size … exhausted” error. Every time we fetched data, we were allocating the full\ndataset and building the same representation in objects, this process was slow and require a huge amount of system resources.</p>\n<hr/>\n<p>At this point was obvious that we were handling scans in the wrong way and we needed to come up with a solution.\nLucky, the new AWS SDK for PHP return an Iterator that automatic handles paginated results, and will perform the necessary requests of new items when the next() is called. In this example, I called it OnDemandCollection.</p>\n<p>This technique allow us to reduce the amount of memory and also scatter the consumed capacity along each iteration.</p>\n<p><sup>If you love filters as we do, you probably want to check <a href=\"/house-rules-on-search/\">House rules on search</a>.</sup> </p>\n<hr>","timeToRead":2,"frontmatter":{"title":"DynamoDb OnDemand Hydrator","date":"January 27, 2017","spoiler":"At Uniplaces we use a DynamoDB as our main database. DynamoDB is NoSQL and distributed database from Amazon webservices that automatically spreads the data and traffic for the table over a sufficient number of servers to handle the request capacity specified by the customer and the amount of data stored, while maintaining consistent and fast performance."},"fields":{"slug":"/dynamodb-on-demand-hydrator/","langKey":"en","tags":["aws","cloud","dynamodb","php"]}}},"pageContext":{"slug":"/dynamodb-on-demand-hydrator/","previous":null,"next":{"fields":{"slug":"/validate-stripe-webhooks-with-symfony/","langKey":"en","directoryName":"validate-stripe-webhooks-with-symfony","maybeAbsoluteLinks":[]},"frontmatter":{"title":"Validate Stripe webhooks with Symfony"}},"translations":[],"translatedLinks":[]}}}